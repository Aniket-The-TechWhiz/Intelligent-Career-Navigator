<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mock Interview - Mini Interview Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the scrollbar to make it look nicer */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Ensure font-inter is used globally */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom styles for interview type cards */
        .interview-type-card {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .interview-type-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .interview-type-card.selected {
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.3), 0 10px 15px rgba(99, 102, 241, 0.1);
            background-color: #eef2ff; /* indigo-50 */
        }
        .interview-type-card.selected svg {
            color: #6366f1; /* indigo-500 */
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-purple-500 to-indigo-600 p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl flex flex-col h-[90vh] lg:h-[80vh] overflow-hidden">
        <header class="p-4 bg-indigo-700 text-white rounded-t-xl flex justify-between items-center z-10">
            <h1 class="text-2xl font-bold">AI Mock Interview</h1>
            <div class="flex space-x-2">
                <button
                    id="endInterviewButton"
                    class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition duration-300 ease-in-out shadow-md hidden"
                >
                    End Interview
                </button>
                <button
                    id="backToSetupButton"
                    class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300 ease-in-out shadow-md hidden"
                >
                    Back to Setup
                </button>
            </div>
        </header>

        <div id="setupScreen" class="flex-1 overflow-y-auto p-6 transition-opacity duration-500 ease-in-out opacity-100">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">AI Mock Interview</h2>
            <p class="text-gray-600 mb-8">Practice with our AI interviewer and get real-time feedback to improve your performance.</p>

            <section class="mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Interview Setup</h3>
                <form id="interviewSetupForm" class="space-y-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Select Interview Type</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="interview-type-card p-4 border border-gray-300 rounded-lg flex flex-col items-center text-center hover:border-indigo-400" data-type="general">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-500 mb-2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H16.5M21 12c0 1.011-.664 1.956-1.63 2.348a9.71 9.71 0 0 1-5.903 2.052c-2.433 0-4.706-.97-6.66-2.735C4.304 14.167 3 12.483 3 10.5V6a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 6v4.5Z" />
                                </svg>
                                <span class="font-medium text-gray-800">General Interview</span>
                                <p class="text-xs text-gray-500 mt-1">Common behavioral and situational questions</p>
                            </div>
                            <div class="interview-type-card p-4 border border-gray-300 rounded-lg flex flex-col items-center text-center hover:border-indigo-400" data-type="technical">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-500 mb-2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.429 9.75 2.25 12l4.179 2.25m0-4.5 3.976-3.976l4.122 4.122m0-4.62L17.75 12l-4.179 2.25M12 18.75l3.976-3.976M12 18.75l-3.976-3.976m4.62-4.62L12 10.5m4.179-4.179L21.75 12l-4.179 2.25m0-4.5L12 9.75l-4.179-4.179M4.5 19.5h15" />
                                </svg>
                                <span class="font-medium text-gray-800">Technical Interview</span>
                                <p class="text-xs text-gray-500 mt-1">Role-specific technical questions</p>
                            </div>
                            <div class="interview-type-card p-4 border border-gray-300 rounded-lg flex flex-col items-center text-center hover:border-indigo-400" data-type="leadership">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-500 mb-2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21l11.021-11.021c.328-.328.7-.585 1.09-.775 1.089-.523 2.29-.537 3.39-.033.4.183.758.423 1.066.709l2.495 2.495c.421.421.421 1.104 0 1.525-.421.421-1.104.421-1.525 0l-2.495-2.495a1.2 1.2 0 0 0-1.066-.709c-.933-.047-1.785.197-2.395.787a2.122 2.122 0 0 1-1.09.775L3.75 21Z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 16.5H21L12 3 3 16.5h5.25" />
                                </svg>
                                <span class="font-medium text-gray-800">Leadership Interview</span>
                                <p class="text-xs text-gray-500 mt-1">Focus on leadership and management skills</p>
                            </div>
                            <div class="interview-type-card p-4 border border-gray-300 rounded-lg flex flex-col items-center text-center hover:border-indigo-400" data-type="club-custom">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-500 mb-2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 0 0-.491 6.347A48.974 48.974 0 0 1 3.1 20.25l.08-.08a6.75 6.75 0 0 1 1.625-1.516 11.703 11.703 0 0 0 4.14 2.135 12.003 12.003 0 0 0 7.378-1.529 12.003 12.003 0 0 0 7.378 1.529 11.703 11.703 0 0 0 4.14-2.135 6.75 6.75 0 0 1 1.625 1.516l.08.08a48.974 48.974 0 0 1-.67 3.75c-.266.752-.614 1.481-1.026 2.162m-9.088-9.088a6.75 6.75 0 0 0-7.378-1.529 12.003 12.003 0 0 0-7.378 1.529 11.703 11.703 0 0 0-4.14-2.135 6.75 6.75 0 0 1-1.625 1.516l-.08-.08c-.67-.67-.704-1.74-.08-2.613a48.974 48.974 0 0 1 .67-3.75c.266-.752.614-1.481 1.026-2.162m9.088 9.088a6.75 6.75 0 0 0 7.378 1.529 12.003 12.003 0 0 0 7.378-1.529 11.703 11.703 0 0 0 4.14-2.135 6.75 6.75 0 0 1 1.625 1.516l.08.08c-.67-.67-.704-1.74-.08-2.613a48.974 48.974 0 0 1-.67-3.75c-.266-.752-.614-1.481-1.026-2.162m-9.088-9.088a6.75 6.75 0 0 0-7.378-1.529 12.003 12.003 0 0 0-7.378 1.529 11.703 11.703 0 0 0-4.14-2.135 6.75 6.75 0 0 1-1.625 1.516l-.08-.08c-.67-.67-.704-1.74-.08-2.613a48.974 48.974 0 0 1 .67-3.75c.266-.752.614-1.481 1.026-2.162" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 21.75V4.5M4.5 9.75h15" />
                                </svg>
                                <span class="font-medium text-gray-800">Club Custom</span>
                                <p class="text-xs text-gray-500 mt-1">Custom questions set by your college club</p>
                            </div>
                        </div>
                        <input type="hidden" id="interviewType" name="interviewType" required>
                    </div>

                    <div>
                        <label for="rolePosition" class="block text-gray-700 text-sm font-semibold mb-2">Role/Position</label>
                        <input
                            type="text"
                            id="rolePosition"
                            name="rolePosition"
                            placeholder="e.g., Software Developer, Product Manager"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            required
                            list="roleSuggestions"
                        >
                        <datalist id="roleSuggestions">
                            <option value="Software Developer">
                            <option value="Product Manager">
                            <option value="Data Analyst">
                            <option value="UX Designer">
                            <option value="Marketing Specialist">
                            <option value="Team Lead">
                            <option value="Project Manager">
                        </datalist>
                    </div>

                    <div>
                        <label for="experienceLevel" class="block text-gray-700 text-sm font-semibold mb-2">Experience Level</label>
                        <select
                            id="experienceLevel"
                            name="experienceLevel"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 appearance-none bg-white pr-8"
                            required
                        >
                            <option value="">Select an option</option>
                            <option value="fresher">Fresher</option>
                            <option value="1-2">1–2 years</option>
                            <option value="3-5">3–5 years</option>
                            <option value="5+">5+ years</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Interview Duration (For Testing)</label>
                        <p class="text-lg font-bold text-indigo-600">1 minute</p>
                        <input type="hidden" id="interviewDuration" name="interviewDuration" value="1">
                    </div>
                </form>
            </section>

            <section class="mb-8 p-6 bg-indigo-50 rounded-lg shadow-inner border border-indigo-200">
                <h3 class="text-xl font-semibold text-indigo-800 mb-4">Before You Start</h3>
                <ul class="space-y-2 text-gray-700">
                    <li class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-green-500 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        Ensure you have a stable internet connection
                    </li>
                    <li class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-green-500 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        Find a quiet, well-lit space
                    </li>
                    <li class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-green-500 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        Test your camera and microphone
                    </li>
                    <li class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-green-500 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        Have a copy of your resume ready
                    </li>
                </ul>
            </section>

            <div class="flex justify-center mb-6">
                <button
                    id="startInterviewButton"
                    type="submit"
                    form="interviewSetupForm"
                    class="bg-purple-600 hover:bg-purple-700 text-white text-lg font-semibold px-8 py-4 rounded-full shadow-lg transform transition-all duration-300 ease-in-out hover:scale-105"
                >
                    Start Interview
                </button>
            </div>
        </div>

        <div id="chatInterface" class="flex-1 overflow-y-auto p-4 space-y-4 chat-messages hidden">
            </div>

        <div id="inputArea" class="p-4 border-t border-gray-200 flex items-center bg-gray-50 rounded-b-xl hidden">
            <textarea
                id="userInput"
                class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none h-12 overflow-hidden"
                placeholder="Type your answer here..."
                rows="1"
                style="min-height: 48px; max-height: 120px;"
            ></textarea>
            <button
                id="speechButton"
                class="ml-3 px-4 py-3 rounded-lg text-white font-semibold transition duration-300 ease-in-out shadow-md bg-green-600 hover:bg-green-700 transform hover:scale-105"
                title="Start Speech Input"
            >
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path d="M8.25 4.5a.75.75 0 0 1 .75-.75h.75a.75.75 0 0 1 .75.75v.75h-2.25V4.5ZM12 2.25a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM15.75 4.5a.75.75 0 0 1 .75-.75h.75a.75.75 0 0 1 .75.75v.75h-2.25V4.5ZM12 18a6 6 0 0 0 6-6v-1.5a.75.75 0 0 1 1.5 0V12A7.5 7.5 0 0 1 4.5 12v-1.5a.75.75 0 0 1 1.5 0V12a6 6 0 0 0 6 6Z" />
                    <path d="M12 5.25a5.25 5.25 0 0 0-5.25 5.25v3a.75.75 0 0 1-1.5 0v-3A6.75 6.75 0 0 1 18.75 12v1.5a.75.75 0 0 1-1.5 0V12a5.25 5.25 0 0 0-5.25-5.25Z" />
                </svg>
            </button>
            <button
                id="sendButton"
                class="ml-3 px-6 py-3 rounded-lg text-white font-semibold transition duration-300 ease-in-out shadow-md bg-indigo-600 hover:bg-indigo-700 transform hover:scale-105"
            >
                Send
            </button>
        </div>

        <div id="feedbackScreen" class="flex-1 overflow-y-auto p-6 transition-opacity duration-500 ease-in-out hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Your Interview Feedback</h2>
            <div id="feedbackContent" class="bg-gray-100 p-6 rounded-lg shadow-md mb-6 text-gray-700 leading-relaxed">
                <p>Generating feedback...</p>
            </div>
            <div class="flex justify-center">
                <button
                    id="retakeInterviewButton"
                    class="bg-purple-600 hover:bg-purple-700 text-white text-lg font-semibold px-8 py-4 rounded-full shadow-lg transform transition-all duration-300 ease-in-out hover:scale-105"
                >
                    Retake Interview
                </button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const setupScreen = document.getElementById('setupScreen');
        const chatInterface = document.getElementById('chatInterface');
        const inputArea = document.getElementById('inputArea');
        const feedbackScreen = document.getElementById('feedbackScreen');
        const feedbackContent = document.getElementById('feedbackContent');

        const interviewSetupForm = document.getElementById('interviewSetupForm');
        const startInterviewButton = document.getElementById('startInterviewButton');
        const backToSetupButton = document.getElementById('backToSetupButton');
        const endInterviewButton = document.getElementById('endInterviewButton');
        const retakeInterviewButton = document.getElementById('retakeInterviewButton');

        const interviewTypeCards = document.querySelectorAll('.interview-type-card');
        const interviewTypeInput = document.getElementById('interviewType');
        const rolePositionInput = document.getElementById('rolePosition');
        const experienceLevelSelect = document.getElementById('experienceLevel');
        const interviewDurationInput = document.getElementById('interviewDuration');

        // Existing chat elements
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const speechButton = document.getElementById('speechButton');

        let messages = [];
        let isLoading = false;
        let interviewConfig = {}; // Object to store interview settings
        let recognition; // SpeechRecognition object
        let interviewTimeout; // Timer for interview duration

        // Speech Synthesis (Text-to-Speech) setup
        const synth = window.speechSynthesis;
        let selectedVoice = null;

        function populateVoiceList() {
            const voices = synth.getVoices();
            selectedVoice = voices.find(voice => voice.lang === 'en-US' && voice.name.includes('Google') || voice.lang === 'en-GB');
            if (!selectedVoice) {
                selectedVoice = voices.find(voice => voice.lang.startsWith('en'));
            }
            if (!selectedVoice && voices.length > 0) {
                selectedVoice = voices[0];
            }
            console.log('Selected voice:', selectedVoice ? selectedVoice.name : 'Default voice');
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }
        populateVoiceList();

        const speakText = (text) => {
            if (synth.speaking) {
                synth.cancel();
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = selectedVoice;
            utterance.pitch = 1;
            utterance.rate = 1;
            synth.speak(utterance);
        };

        // Speech Recognition setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                speechButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                speechButton.classList.add('bg-red-500', 'animate-pulse');
                speechButton.title = 'Stop Speech Input';
                userInput.placeholder = 'Listening...';
                synth.cancel();
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                userInput.value = finalTranscript || interimTranscript;
                adjustTextareaHeight();
            };

            recognition.onend = () => {
                speechButton.classList.remove('bg-red-500', 'animate-pulse');
                speechButton.classList.add('bg-green-600', 'hover:bg-green-700');
                speechButton.title = 'Start Speech Input';
                userInput.placeholder = 'Type your answer here...';

                // Automatically send message if there is a final transcript
                if (userInput.value.trim() !== '') {
                    handleSendMessage();
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                speechButton.classList.remove('bg-red-500', 'animate-pulse');
                speechButton.classList.add('bg-green-600', 'hover:bg-green-700');
                speechButton.title = 'Start Speech Input';
                userInput.placeholder = 'Type your answer here...';
                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please allow microphone access in your browser settings to use speech input.');
                }
            };

            speechButton.addEventListener('click', () => {
                if (speechButton.classList.contains('bg-red-500')) {
                    recognition.stop();
                } else {
                    userInput.value = '';
                    recognition.start();
                }
            });
        } else {
            speechButton.style.display = 'none';
            console.warn('Web Speech API is not supported in this browser.');
        }

        // Utility function for exponential backoff
        const callWithExponentialBackoff = async (func, retries = 5, delay = 1000) => {
            try {
                return await func();
            } catch (error) {
                if (retries > 0 && (error.status === 429 || (error.status >= 500 && error.status < 600))) {
                    await new Promise(res => setTimeout(res, delay));
                    return callWithExponentialBackoff(func, retries - 1, delay * 2);
                }
                throw error;
            }
        };

        // Function to display messages in the chat interface
        const displayMessage = (message) => {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-[70%] p-3 rounded-lg shadow-md ${
                message.role === 'user'
                    ? 'bg-blue-500 text-white rounded-br-none'
                    : 'bg-gray-200 text-gray-800 rounded-bl-none'
            }`;
            messageBubble.innerText = message.parts[0].text;

            messageWrapper.appendChild(messageBubble);
            chatInterface.appendChild(messageWrapper);
            chatInterface.scrollTop = chatInterface.scrollHeight;

            if (message.role === 'model') {
                speakText(message.parts[0].text);
            }
        };

        // Function to show/hide loading indicator
        const showLoading = (show) => {
            if (show) {
                isLoading = true;
                sendButton.disabled = true;
                sendButton.innerText = 'Sending...';
                sendButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                sendButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'transform', 'hover:scale-105');
                if (speechButton) speechButton.disabled = true;

                const loadingWrapper = document.createElement('div');
                loadingWrapper.id = 'loadingIndicator';
                loadingWrapper.className = 'flex justify-start';
                loadingWrapper.innerHTML = `
                    <div class="max-w-[70%] p-3 rounded-lg shadow-md bg-gray-200 text-gray-800 rounded-bl-none">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse delay-75"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse delay-150"></div>
                        </div>
                    </div>
                `;
                chatInterface.appendChild(loadingWrapper);
                chatInterface.scrollTop = chatInterface.scrollHeight;
            } else {
                isLoading = false;
                sendButton.disabled = false;
                sendButton.innerText = 'Send';
                sendButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                sendButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'transform', 'hover:scale-105');
                if (speechButton) speechButton.disabled = false;

                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
            }
        };

        // Handle sending messages to AI
        const handleSendMessage = async () => {
            const text = userInput.value.trim();
            if (text === '' || isLoading) return;

            // No need to stop recognition here, it should already be 'onend' if triggered by speech
            synth.cancel();

            const userMessage = { role: 'user', parts: [{ text: text }] };
            messages.push(userMessage);
            displayMessage(userMessage);
            userInput.value = '';
            userInput.style.height = '48px';
            showLoading(true);

            try {
                const chatHistory = [...messages];

                const payload = {
                    contents: chatHistory,
                };

                const apiKey = "AIzaSyAYRIOGJiBxqf9T3QDmQQgKx-dM1O-b86o"; // Replace with your actual API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const fetchResponse = async () => {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        const error = new Error(`HTTP error! status: ${response.status}. ${errorData.error.message || ''}`);
                        error.status = response.status;
                        throw error;
                    }
                    return response.json();
                };

                const result = await callWithExponentialBackoff(fetchResponse);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponseText = result.candidates[0].content.parts[0].text;
                    const aiMessage = { role: 'model', parts: [{ text: aiResponseText }] };
                    messages.push(aiMessage);
                    displayMessage(aiMessage);
                } else {
                    console.error("Unexpected API response structure:", result);
                    const errorMessage = { role: 'model', parts: [{ text: "I'm sorry, I couldn't generate a response. Please try again." }] };
                    messages.push(errorMessage);
                    displayMessage(errorMessage);
                }
            } catch (error) {
                console.error("Error generating content:", error);
                const errorMessage = { role: 'model', parts: [{ text: "Oops! Something went wrong. Please try sending your message again." }] };
                messages.push(errorMessage);
                displayMessage(errorMessage);
            } finally {
                showLoading(false);
            }
        };

        // Adjust textarea height automatically
        const adjustTextareaHeight = () => {
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';
            if (parseInt(userInput.style.height, 10) > 120) {
                userInput.style.overflowY = 'auto';
            } else {
                userInput.style.overflowY = 'hidden';
            }
        };

        // --- Setup Screen Logic ---
        interviewTypeCards.forEach(card => {
            card.addEventListener('click', () => {
                interviewTypeCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                interviewTypeInput.value = card.dataset.type;
            });
        });

        startInterviewButton.addEventListener('click', (e) => {
            e.preventDefault();

            if (!interviewTypeInput.value) {
                alert('Please select an Interview Type.');
                return;
            }
            if (!rolePositionInput.value.trim()) {
                alert('Please enter your Role/Position.');
                return;
            }
            if (!experienceLevelSelect.value) {
                alert('Please select your Experience Level.');
                return;
            }

            interviewConfig = {
                type: interviewTypeInput.value,
                role: rolePositionInput.value.trim(),
                experience: experienceLevelSelect.value,
                duration: parseInt(interviewDurationInput.value) // Fixed to 1 minute for testing
            };

            setupScreen.style.opacity = '0';
            setupScreen.style.pointerEvents = 'none';

            setTimeout(() => {
                setupScreen.classList.add('hidden');
                chatInterface.classList.remove('hidden');
                inputArea.classList.remove('hidden');
                backToSetupButton.classList.remove('hidden');
                endInterviewButton.classList.remove('hidden');

                chatInterface.style.opacity = '0';
                inputArea.style.opacity = '0';
                setTimeout(() => {
                    chatInterface.style.opacity = '1';
                    inputArea.style.opacity = '1';
                }, 50);

                showLoading(true);
                let initialMessageText = `Hello! Welcome to your ${interviewConfig.type} interview for a ${interviewConfig.role} position at ${interviewConfig.experience} experience level. This interview will last about ${interviewConfig.duration} minute. Let's begin. Tell me a bit about yourself.`;
                const initialAIMessage = { role: 'model', parts: [{ text: initialMessageText }] };
                messages.push(initialAIMessage);
                displayMessage(initialAIMessage);
                showLoading(false);

                interviewTimeout = setTimeout(endInterview, interviewConfig.duration * 60 * 1000);

            }, 500);
        });

        const endInterview = async () => {
            clearTimeout(interviewTimeout);
            synth.cancel();
            if (recognition && speechButton.classList.contains('bg-red-500')) {
                recognition.stop(); // Stop any active speech recognition
            }

            chatInterface.style.opacity = '0';
            inputArea.style.opacity = '0';
            endInterviewButton.classList.add('hidden');
            backToSetupButton.classList.add('hidden');

            setTimeout(async () => {
                chatInterface.classList.add('hidden');
                inputArea.classList.add('hidden');
                feedbackScreen.classList.remove('hidden');

                feedbackScreen.style.opacity = '0';
                setTimeout(() => { feedbackScreen.style.opacity = '1'; }, 50);

                feedbackContent.innerHTML = `<p class="text-center">Generating your personalized feedback. Please wait...</p>`;
                showLoading(true);

                try {
                    const feedbackPrompt = {
                        role: 'user',
                        parts: [{ text: `Based on the following interview transcript, please provide constructive feedback on the candidate's performance. Focus on communication clarity, relevance of answers, confidence, and areas for improvement. Also, suggest one specific question the candidate could have answered better.

                        Interview Type: ${interviewConfig.type}
                        Role: ${interviewConfig.role}
                        Experience: ${interviewConfig.experience}
                        Duration: ${interviewConfig.duration} minute

                        Transcript:\n\n${messages.map(m => `${m.role.toUpperCase()}: ${m.parts[0].text}`).join('\n')}` }]
                    };

                    const payload = {
                        contents: [feedbackPrompt],
                    };

                    const apiKey = "AIzaSyAYRIOGJiBxqf9T3QDmQQgKx-dM1O-b86o"; // Replace with your actual API key
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    const fetchResponse = async () => {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            const error = new Error(`HTTP error! status: ${response.status}. ${errorData.error.message || ''}`);
                            error.status = response.status;
                            throw error;
                        }
                        return response.json();
                    };

                    const result = await callWithExponentialBackoff(fetchResponse);

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const feedbackText = result.candidates[0].content.parts[0].text;
                        feedbackContent.innerHTML = `<pre class="whitespace-pre-wrap">${feedbackText}</pre>`;
                    } else {
                        feedbackContent.innerHTML = `<p class="text-red-500">Could not generate feedback. Please try again.</p>`;
                        console.error("Unexpected API response structure for feedback:", result);
                    }
                } catch (error) {
                    console.error("Error generating feedback:", error);
                    feedbackContent.innerHTML = `<p class="text-red-500">An error occurred while generating feedback. Please try again.</p>`;
                } finally {
                    showLoading(false);
                }
            }, 500);
        };

        backToSetupButton.addEventListener('click', () => {
            clearTimeout(interviewTimeout);
            synth.cancel();
            if (recognition && speechButton.classList.contains('bg-red-500')) {
                recognition.stop();
            }

            messages = [];
            userInput.value = '';
            chatInterface.innerHTML = '';
            feedbackContent.innerHTML = '<p>Generating feedback...</p>';
            userInput.style.height = '48px';
            showLoading(false);

            chatInterface.style.opacity = '0';
            inputArea.style.opacity = '0';
            endInterviewButton.classList.add('hidden');
            backToSetupButton.classList.add('hidden');
            feedbackScreen.classList.add('hidden');

            setTimeout(() => {
                chatInterface.classList.add('hidden');
                inputArea.classList.add('hidden');
                setupScreen.classList.remove('hidden');

                setupScreen.style.opacity = '0';
                setupScreen.style.pointerEvents = 'auto';
                setTimeout(() => {
                    setupScreen.style.opacity = '1';
                }, 50);
            }, 500);
        });

        retakeInterviewButton.addEventListener('click', () => {
            feedbackScreen.style.opacity = '0';
            setTimeout(() => {
                feedbackScreen.classList.add('hidden');
                backToSetupButton.click();
            }, 500);
        });

        // --- Chat Interface Event Listeners ---
        endInterviewButton.addEventListener('click', endInterview);
        // Keep send button for manual typing if user prefers
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });
        userInput.addEventListener('input', adjustTextareaHeight);

        // Initial setup for textarea
        adjustTextareaHeight();

        // Set a default selected interview type on load
        document.querySelector('.interview-type-card[data-type="general"]').click();
    </script>
</body>
</html>